<script>

/* =========================================================
   PROFESSIONAL SYRIAN HAMSTER GENETICS ENGINE
   Clean, deterministic, fully editable architecture
========================================================= */


/* =========================================================
   1️⃣ LOCUS DEFINITIONS
   Each locus is defined once here.
   Easy to add/edit.
========================================================= */

const LOCI = {

  A: { name: "Agouti", alleles: ["A", "a"] },
  B: { name: "Brown", alleles: ["B", "b"] },
  E: { name: "Extension", alleles: ["E", "e"] },
  P: { name: "Pink Eye", alleles: ["P", "p"] },
  CD: { name: "Dark Eared White", alleles: ["CD", "cd"] },
  DG: { name: "Dark Grey", alleles: ["DG", "dg"] },
  LG: { name: "Light Grey", alleles: ["LG", "Lg"] },
  SG: { name: "Silver Grey", alleles: ["SG", "Sg"] },
  CE: { name: "Extreme Dilute", alleles: ["CE", "ce"] },
  U: { name: "Umbrous", alleles: ["U", "u"] },

  /* Sex-linked locus handled separately */
};


/* =========================================================
   2️⃣ HELPER FUNCTIONS
========================================================= */

function splitPair(pair) {
  return pair.split("/");
}

function sortPair(a, b) {
  return [a, b].sort().join("/");
}

function generatePunnettSquare(parent1, parent2) {
  const results = {};

  parent1.forEach(a1 => {
    parent2.forEach(a2 => {
      const child = sortPair(a1, a2);
      results[child] = (results[child] || 0) + 1;
    });
  });

  // convert counts to probabilities
  Object.keys(results).forEach(key => {
    results[key] = results[key] / 4;
  });

  return results;
}


/* =========================================================
   3️⃣ SEX LINKED YELLOW (To)
========================================================= */

function generateSexLinkedPunnett(dadPair, momPair) {

  const results = {};

  dadPair.forEach(d => {
    momPair.forEach(m => {

      let sex, genotype;

      if (d === "Y") {
        sex = "Male";
        genotype = m + "/Y";
      } else {
        sex = "Female";
        genotype = sortPair(d, m);
      }

      const key = genotype + "|" + sex;
      results[key] = (results[key] || 0) + 1;
    });
  });

  Object.keys(results).forEach(k => {
    results[k] = results[k] / 4;
  });

  return results;
}


/* =========================================================
   4️⃣ FULL GENOTYPE COMBINATION BUILDER
========================================================= */

function combineAllLoci(locusResults, yellowResults) {

  let combined = {};

  function recurse(lociKeys, index, currentKey, probability) {

    if (index === lociKeys.length) {

      Object.entries(yellowResults).forEach(([yellowKey, yProb]) => {

        const finalKey = currentKey + "|" + yellowKey;
        combined[finalKey] = (combined[finalKey] || 0) + probability * yProb;

      });

      return;
    }

    const locusName = lociKeys[index];
    const locusData = locusResults[locusName];

    Object.entries(locusData).forEach(([geno, prob]) => {
      recurse(lociKeys, index + 1, currentKey + "|" + geno, probability * prob);
    });

  }

  recurse(Object.keys(locusResults), 0, "", 1);

  return combined;
}


/* =========================================================
   5️⃣ PHENOTYPE RESOLUTION ENGINE
   Layered logic — clean and editable
========================================================= */

function resolvePhenotype(genoString, sex) {

  const g = genoString;

  /* ---------- BASE COLORS ---------- */

  let phenotype = "Golden";

  if (g.includes("a/a"))
    phenotype = "Black";

  if (g.includes("b/b"))
    phenotype = "Rust";

  if (g.includes("p/p"))
    phenotype = "Cinnamon";

  if (g.includes("cd/cd"))
    phenotype = "Dark Eared White";

  if (g.includes("dg/dg"))
    phenotype = "Dark Grey";

  if (g.includes("Lg/Lg"))
    phenotype = "Light Grey";

  if (g.includes("Sg/Sg"))
    phenotype = "Silver Grey";

  if (g.includes("ce/ce"))
    phenotype = "Extreme Dilute";

  if (g.includes("e/e"))
    phenotype = "Black Eyed Cream";


  /* ---------- COMBINATION COLORS (Sample Start) ---------- */

  if (g.includes("a/a") && g.includes("b/b"))
    phenotype = "Chocolate";

  if (g.includes("a/a") && g.includes("p/p"))
    phenotype = "Dove";

  if (g.includes("a/a") && g.includes("b/b") && g.includes("p/p"))
    phenotype = "Champagne";

  if (g.includes("e/e") && g.includes("U"))
    phenotype = "Sable";

  if (g.includes("p/p") && g.includes("Sg/Sg"))
    phenotype = "Blonde (Sg var.)";

  if (g.includes("dg/dg") && g.includes("To") && sex === "Male")
    phenotype = "Smoke Pearl";

  if (g.includes("e/e") && g.includes("Sg/Sg"))
    phenotype = "Black Eyed White";


  /* ---------- YELLOW + TORTOISESHELL ---------- */

  if (sex === "Female" && g.includes("To/to"))
    phenotype = "Tortoiseshell " + phenotype;

  if (sex === "Male" && g.includes("To/Y"))
    phenotype = "Yellow";


  return phenotype;
}


/* =========================================================
   6️⃣ MAIN RUN FUNCTION
========================================================= */

function runEngine(dadData, momData) {

  const locusResults = {};

  Object.keys(LOCI).forEach(locus => {

    const dadPair = splitPair(dadData[locus]);
    const momPair = splitPair(momData[locus]);

    locusResults[locus] = generatePunnettSquare(dadPair, momPair);
  });

  const yellowResults = generateSexLinkedPunnett(
    splitPair(dadData["To"]),
    splitPair(momData["To"])
  );

  const fullGenotypes = combineAllLoci(locusResults, yellowResults);

  return fullGenotypes;
}


/* =========================================================
   7️⃣ 12 PUP DISTRIBUTION
========================================================= */

function distributeTo12(probMap) {

  const pups = [];

  Object.entries(probMap).forEach(([geno, prob]) => {

    const count = Math.round(prob * 12);

    for (let i = 0; i < count; i++) {
      pups.push(geno);
    }

  });

  return pups.slice(0, 12);
}

</script>